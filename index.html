<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>‡πÅ‡∏ö‡∏ö‡∏ü‡∏≠‡∏£‡πå‡∏° Kaizen</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    input[type=text], input[type=date], textarea, select {
      width: 100%; padding: 12px; margin: 8px 0;
      border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
    }
    input[readonly] {
      background-color: #f2f2f2;
      color: #555;
    }
    button {
      width: 100%; background-color: #4CAF50; color: white;
      padding: 14px; margin: 8px 0; border: none;
      border-radius: 4px; cursor: pointer; font-size: 16px;
    }
    button:hover { background-color: #45a049; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    h1 { text-align: center; }
    label { font-weight: bold; }
  </style>
</head>
<body>

<h1>‡πÑ‡∏Ñ‡πÄ‡∏ã‡πá‡∏ô</h1>
<form id="kaizenForm">

  <label for="dueDate">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏à‡πâ‡∏á‡∏ó‡∏≥:</label>
  <input type="date" id="dueDate" name="dueDate" required>

  <label for="title">‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏™‡πà‡∏á‡πÑ‡∏Ñ‡πÄ‡∏ã‡πá‡∏ô:</label>
  <input type="text" id="title" name="title" required>

  <label for="location">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà:</label>
  <input type="text" id="location" name="location" required>

  <label for="group5s">‡∏Å‡∏•‡∏∏‡πà‡∏° 5‡∏™.:</label>
   <select id="group5s" name="group5s" required>
       <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°5‡∏™...</option>
       <option value="‡∏ó‡∏µ‡∏•‡∏∞‡∏Å‡πâ‡∏≤‡∏ß">‡∏ó‡∏µ‡∏•‡∏∞‡∏Å‡πâ‡∏≤‡∏ß</option>
       <option value="5‡∏™.‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ">5‡∏™.‡∏™‡∏≤‡∏°‡∏±‡∏Ñ‡∏Ñ‡∏µ</option>
       <option value="‡∏ü‡∏£‡∏∏‡πâ‡∏á‡∏ü‡∏£‡∏¥‡πâ‡∏á">‡∏ü‡∏£‡∏∏‡πâ‡∏á‡∏ü‡∏£‡∏¥‡πâ‡∏á</option>
       <option value="‡πÇ‡∏£‡∏ö‡∏¥‡∏ô‡∏Æ‡∏π‡πâ‡∏î">‡πÇ‡∏£‡∏ö‡∏¥‡∏ô‡∏Æ‡∏π‡πâ‡∏î</option>
       <option value="‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏™‡∏ß">‡∏™‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏™‡∏ß</option>
       <option value="‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏≤‡∏á">‡∏£‡∏ß‡∏°‡∏ä‡πà‡∏≤‡∏á</option>
     <option value="‡∏ó‡∏µ‡∏°A">‡∏ó‡∏µ‡∏°A</option>
       <option value="My Home">My Home</option>
       <option value="Number one">Number one</option>
   </select>

  <label for="problemDetail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏õ‡∏±‡∏ç‡∏´‡∏≤:</label>
  <textarea id="problemDetail" name="problemDetail" rows="4" required></textarea>

  <label for="imageUpload">‡∏£‡∏π‡∏õ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥:</label>
  <input type="file" id="imageUpload" accept="image/*">

  <hr>

  <label for="afterDetail">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç:</label>
  <textarea id="afterDetail" name="afterDetail" rows="4"></textarea>

  <label for="afterImageUpload">‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥:</label>
  <input type="file" id="afterImageUpload" accept="image/*">

  <hr>

  <!-- ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user -->
  <label for="department">‡πÅ‡∏ú‡∏ô‡∏Å:</label>
  <input type="text" id="department" readonly>

  <label for="reporterName">‡∏ú‡∏π‡πâ‡πÅ‡∏à‡πâ‡∏á:</label>
  <input type="text" id="reporterName" readonly>

  <label for="empCode">‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô:</label>
  <input type="text" id="empCode" readonly>

  <button type="submit" id="submitBtn">‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
</form>

<script>
  let userId, displayName, pictureUrl;

  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
  window.addEventListener("DOMContentLoaded", () => {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    document.getElementById("dueDate").value = `${yyyy}-${mm}-${dd}`;
  });

  function showLoading() {
    Swal.fire({ 
      title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', 
      allowOutsideClick: false, 
      didOpen: () => Swal.showLoading() 
    });
  }

  function showSuccess(jobId) {
    Swal.fire({
      title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
      text: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß\n(‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏î‡πâ‡∏ß‡∏¢ ‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏£‡∏£‡∏Ñ‡πå 1 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô üòÄ)',
      icon: 'success',
      confirmButtonText: '‡∏õ‡∏¥‡∏î'
    }).then(() => {
      if (liff.isInClient()) {
        liff.closeWindow();
      }
    });
  }

  function showError(msg) {
    return Swal.fire({ 
      title: '‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', 
      text: msg, 
      icon: 'error', 
      confirmButtonText: '‡∏ï‡∏Å‡∏•‡∏á' 
    });
  }

  function fetchUserData(uid) {
    console.log('Fetching user data for UID:', uid);
    return fetch(`https://script.google.com/macros/s/AKfycbyOHFF0q5Ew0zWfHX7zJxOmJ6xTPP0HOdax9jo0nivQZbKC7tVMePZkaYVaJnlL-pTM/exec?userId=${uid}`)
      .then(res => {
        console.log('Response status:', res.status);
        if (!res.ok) {
          throw new Error(`HTTP ${res.status}`);
        }
        return res.json();
      })
      .then(data => {
        console.log('User data:', data);
        return data;
      })
      .catch(err => { 
        console.error('Fetch error:', err); 
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á showError ‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏à‡∏∞ handle ‡∏ó‡∏µ‡πà .then() ‡∏Ç‡πâ‡∏≤‡∏á‡∏•‡πà‡∏≤‡∏á
        return { status: "error", message: "‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• user ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: " + err.message };
      });
  }

  document.getElementById("kaizenForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    console.log('Form submitted');
    
    // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤‡∏õ‡∏∏‡πà‡∏°‡∏ñ‡∏π‡∏Å disable ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (document.getElementById("submitBtn").disabled) {
      showError("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô");
      return;
    }
    
    showLoading();

    try {
      const beforeFile = document.getElementById("imageUpload").files[0];
      const afterFile = document.getElementById("afterImageUpload").files[0];

      const encodeFile = (file) => {
        return new Promise((resolve) => {
          if (!file) return resolve({ base64: "", name: "", type: "" });
          const reader = new FileReader();
          reader.onloadend = () => {
            resolve({ 
              base64: reader.result.split(',')[1], 
              name: file.name, 
              type: file.type 
            });
          };
          reader.readAsDataURL(file);
        });
      };

      const beforeImg = await encodeFile(beforeFile);
      const afterImg = await encodeFile(afterFile);

      const data = {
        dueDate: document.getElementById("dueDate").value,
        title: document.getElementById("title").value,
        location: document.getElementById("location").value,
        group5s: document.getElementById("group5s").value,
        problemDetail: document.getElementById("problemDetail").value,

        beforeFileName: beforeImg.name,
        beforeMimeType: beforeImg.type,
        beforeFileData: beforeImg.base64,

        afterDetail: document.getElementById("afterDetail").value,
        afterFileName: afterImg.name,
        afterMimeType: afterImg.type,
        afterFileData: afterImg.base64,

        userId: userId,
        displayName: displayName,
        pictureUrl: pictureUrl,
        department: document.getElementById("department").value,
        reporterName: document.getElementById("reporterName").value,
        empCode: document.getElementById("empCode").value
      };

      console.log('Sending data:', data);

      // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ fetch ‡πÅ‡∏ö‡∏ö‡∏õ‡∏Å‡∏ï‡∏¥‡∏Å‡πà‡∏≠‡∏ô
      try {
        const response = await fetch("https://script.google.com/macros/s/AKfycbyOHFF0q5Ew0zWfHX7zJxOmJ6xTPP0HOdax9jo0nivQZbKC7tVMePZkaYVaJnlL-pTM/exec", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });

        if (response.ok) {
          const result = await response.json();
          console.log('Response:', result);
          
          if (result.status === "success") {
            showSuccess(result.jobId || "AUTO");
          } else {
            showError(result.message || "‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î");
          }
        } else {
          throw new Error(`HTTP ${response.status}`);
        }
      } catch (fetchError) {
        // ‡∏ñ‡πâ‡∏≤ fetch ‡∏õ‡∏Å‡∏ï‡∏¥‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏•‡∏≠‡∏á no-cors
        console.log('Normal fetch failed, trying no-cors:', fetchError.message);
        
        await fetch("https://script.google.com/macros/s/AKfycbyOHFF0q5Ew0zWfHX7zJxOmJ6xTPP0HOdax9jo0nivQZbKC7tVMePZkaYVaJnlL-pTM/exec", {
          method: "POST",
          mode: "no-cors",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        
        // ‡∏ñ‡πâ‡∏≤ no-cors ‡πÑ‡∏°‡πà error ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        showSuccess("AUTO");
      }

    } catch (err) {
      console.error('Submit error:', err);
      showError("‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err.message);
    }
  });

  // Initialize LIFF
  liff.init({ liffId: "2006299650-2BbWbnQl" })
    .then(() => {
      console.log('LIFF initialized');
      if (!liff.isLoggedIn()) {
        console.log('Not logged in, redirecting...');
        return liff.login();
      } else {
        return liff.getProfile();
      }
    })
    .then(profile => {
      if (profile) {
        console.log('Profile:', profile);
        userId = profile.userId;
        displayName = profile.displayName;
        pictureUrl = profile.pictureUrl;

        // Load user data
        return fetchUserData(userId);
      }
    })
    .then(data => {
      // ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ data ‡∏°‡∏µ‡∏Ñ‡πà‡∏≤‡πÅ‡∏•‡∏∞‡∏°‡∏µ status
      if (data && data.status === "success") {
        console.log('Loading user data into form');
        document.getElementById("department").value = data.department || "";
        document.getElementById("reporterName").value = data.reporterName || displayName || "";
        document.getElementById("empCode").value = data.empCode || "";
        
        // ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á
        document.getElementById("submitBtn").disabled = false;
      } else {
        // ‡∏Å‡∏£‡∏ì‡∏µ‡πÑ‡∏°‡πà‡∏û‡∏ö user ‡∏´‡∏£‡∏∑‡∏≠ error
        console.log('User data not found or error:', data);
        const errorMsg = (data && data.message) ? data.message : "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô";
        
        showError(errorMsg).then(() => {
          // ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏î OK
          if (liff.isInClient()) {
            liff.closeWindow();
          }
        });
        
        // ‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
        document.getElementById("submitBtn").disabled = true;
      }
    })
    .catch(err => {
      console.error('LIFF error:', err);
      showError('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠: ' + err.message).then(() => {
        if (liff.isInClient())
      });
    });
</script>

</body>
</html>
